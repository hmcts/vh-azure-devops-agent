parameters:
  - name: subscription
    type: string
  - name: workingDirectory
    type: string
  - name: tfVariables
    type: string
    default: ''
  - name: customCommandOptions
    type: string
    default: ''

steps:

  - task: PowerShell@2
    displayName: 'Compile MOFS'
    inputs:
      targetType: 'inline'
      script: |
        cd ../dsc
        Install-Module cChoco -Force
        . ./SelfHostedAgent.ps1
        SelfHostedAgent --OutputPath ./dsc -azureDevOpsPAT "fsdfdfdfb" -numberOfAgents 2 -azureDevOpsURL "https://dev.azure.com/hmcts"
        Get-Content ../dsc/SelfHostedAgent.mof | Set-Content -Encoding utf8 "../terraform/SelfHostedAgent.mof"
  
  - task: TerraformCLI@0
    displayName: Terraform Plan
    inputs:
      command: plan
      workingDirectory: ${{ parameters.workingDirectory }}
      environmentServiceName: ${{ parameters.subscription }}
      commandOptions: ${{ parameters.customCommandOptions }}

  - task: ArchiveFiles@2
    displayName: 'Zip Terraform Files'
    inputs:
      rootFolderOrFile: '${{ parameters.workingDirectory }}'
      archiveType: zip
      archiveFile: '${{ parameters.workingDirectory }}/$(Build.BuildId)-AzureDevOps-Agent.zip'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Terraform Artifacts'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/$(Build.BuildId)-AzureDevOps-Agent.zip'
      publishLocation: pipeline
      artifact: '$(Build.BuildId)-AzureDevOps-Agent'