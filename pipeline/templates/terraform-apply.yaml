parameters:
  - name: subscription
    type: string
  - name: workingDirectory
    type: string
  - name: planLocation
    type: string

steps:
- task: TerraformCLI@0
  name : terraformApply
  displayName: Terraform Apply
  inputs:
    workingDirectory: ${{ parameters.workingDirectory }}
    command: apply
    environmentServiceName: ${{ parameters.subscription }}
    commandOptions: -input=false -auto-approve "${{ parameters.planLocation }}"

- powershell: |
    $terraformOutputs = terraform output -json | ConvertFrom-Json
    $outputName = $terraformOutputs | Get-Member -MemberType NoteProperty | % Name
    $values = $terraformOutputs.$outputName.Value

    Write-Host "##vso[task.setvariable variable=$outputName;isoutput=true]$values"

    Write-Output $values
  name: terraformOutput
  displayName: Read terraform outputs