parameters:
  - name: subscription
    type: string
  - name: workingDirectory
    type: string
  - name: planLocation
    type: string

steps:
- task: TerraformCLI@0
  name : tf_apply
  displayName: Terraform Apply
  inputs:
    workingDirectory: ${{ parameters.workingDirectory }}
    command: apply
    environmentServiceName: ${{ parameters.subscription }}
    commandOptions: -input=false -auto-approve "${{ parameters.planLocation }}"

- powershell: Write-Host "##vso[task.setvariable variable=tf_vms;isoutput=true]$(tf_apply.tf_vm_names)"
  name: terraformOutput
  displayName: Read terraform outputs