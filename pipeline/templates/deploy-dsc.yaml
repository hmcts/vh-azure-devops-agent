parameters:
- name: serviceConnection
  type: string
- name: ResourceGroupName
  type: string
- name: automationAccountName
  type: string
- name: vmName
  type: string
- name: devOpsURL
  type: string
- name: patToken
  type: string
- name: agentCount
  type: string


steps:
  - task: AzurePowerShell@5
    displayName: Import DSC Script
    inputs: 
      azureSubscription: $(serviceConnection)
      scriptType: inlineScript
      targetAzurePs: latestVersion
      inline: |
        Import-AzAutomationDscConfiguration -SourcePath "$(System.DefaultWorkingDirectory)/dsc/SelfHostedAgent.ps1" `
                                            -AutomationAccountName "$(automationAccountName)"`
                                            -ResourceGroupName "$(ResourceGroupName)" `
                                            -Published -Force

  - ${{ each vm in split(parameters.vmNames, ', ') }}:
    - task: AzurePowerShell@5
      name: Apply_DSC
      displayName: Apply DSC ${{ vm }}
      inputs: 
        azureSubscription: $(serviceConnection)
        scriptType: inlineScript
        targetAzurePs: latestVersion
        inline: |
          $params = @{
            'vmName'         = "${{ vm }}"
            'azureDevOpsURL' = "$(devOpsURL)"
            'azureDevOpsPAT' = "$(patToken)"
            'numberOfAgents' = "$(agentCount)"
          }

          Start-AzAutomationDscCompilationJob -ResourceGroupName "$(ResourceGroupName)" `
                                              -AutomationAccountName "$(automationAccountName)" `
                                              -ConfigurationName "SelfHostedAgent" `
                                              -Parameters $params

          Register-AzAutomationDscNode -AzureVMName "${{ vm }}" `
                                        -ResourceGroupName "$(ResourceGroupName)" `
                                        -AutomationAccountName "$(automationAccountName)" `
                                        -NodeConfigurationName "SelfHostedAgent.localhost" `
                                        -ConfigurationMode ApplyAndAutocorrect