parameters:
  - name: azureSubscription
    type: string

  - name: packerConfigFile
    type: string

  - name: packerVarFile
    type: string

steps:
- pwsh:
    packer fmt -recursive -check .
  displayName: Packer Format

- pwsh: |
    $version = Get-Date -Format 'ddMMyyyy.0.0'
    Write-Host "##[command]Release Version $version"
    Write-Host "##vso[task.setvariable variable=imageVersion]$version"
  displayName: Create Release Version

- task: AzureCLI@2
  displayName: Packer Build Image
  inputs:
    azureSubscription: ${{ parameters.azureSubscription }}
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $packerFile = "${{ parameters.packerConfigFile }}"
      $variableFile = "${{ parameters.packerVarFile }}"
      $date =  Get-Date -Format 'ddMMyyyy'
      $image = "ubuntu2204-devops-$date"

      packer build -force -var-file="$variableFile" -var image_name="$image" -var image_version="$(imageVersion)" $packerFile