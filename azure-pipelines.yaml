trigger:
  - master
pr:
  - none

parameters:
  - name: Run_Stage
    displayName: Stage to Run
    type: string
    default: 'ValidateTerraform'
    values:
    - ValidateTerraform
    - DeployAzureAgent
    - DestroyAzureAgent

  - name: environment
    displayName: Environment (sandbox default)
    type: string
    default: sandbox # USE upper and lower?
    values:
      - sandbox
 #     - upper
 #     - lower

variables:
  - group: vh-azure-devops-agent
  - name: TF_VAR_RG_NAME
    value: "vh-devops-agent-rg-${{ parameters.environment }}"
  - name: TF_VAR_KV_NAME
    value: "vhdoagentkv${{ parameters.environment }}"
  - name: TF_VAR_VM_NAME
    value: "vh-devops-agent-vm-${{ parameters.environment }}"
  - name: TF_VAR_NSG_NAME
    value: "vh-devops-vm-nsg-${{ parameters.environment }}"
  - name: TF_VAR_VNET_NAME
    value: "vh-devops-vnet-${{ parameters.environment }}"
  - name: workDir
    value: $(System.DefaultWorkingDirectory)/$(tfDirectory)
 

stages:

  - ${{ if eq(parameters.Run_Stage, 'ValidateTerraform') }}:
    - stage: ValidateTerraform
      displayName: 'Validate Infrastructure code'
      jobs:
        - job: Validate_Infra
          displayName: Validate code used to deploy DevOps Agent to ${{ parameters.environment }}
          pool:
            vmImage: 'ubuntu-latest'
          
          steps:

          - template: pipeline-steps/replace-token.yaml
            parameters:
              myConnection: $(patToken)
              workingDirectory: $(workDir)
              environment: ${{ parameters.environment }}

          - template: pipeline-steps/terraform-prep.yaml
            parameters:
              terraformVersion: $(tfVersion)
              subscription: $(subscription)
              environment: ${{ parameters.environment }}
              resourceGroup: $(resourceGroup)
              location: $(location)
              storageAccount: $(storageAccount)
              containerName: $(containerName)
              stateKey: $(stateKey)-${{ parameters.environment }}.tfstate
              workingDirectory: $(workDir)

          - template: pipeline-steps/terraform-plan.yaml
            parameters:
              subscription: $(subscription)
              environment: ${{ parameters.environment }}
              tfVariables: $(System.DefaultWorkingDirectory)/$(tfDirectory)/$(tfVariables)
              workingDirectory: $(workDir)
  
  - ${{ if eq('${{ parameters.Run_Stage }}', 'DeployAzureAgent') }}:
    - stage: DeployAzureAgent
      displayName: Deploy Azure DevOps Agent in ${{ parameters.environment }}
      jobs:
        - job: Deploy_Terraform
          displayName: Deploy DevOps Agent to ${{ parameters.environment }}
          pool:
            vmImage: 'ubuntu-latest'
          
          steps:

            - template: pipeline-steps/replace-token.yaml
              parameters:
                myConnection: $(patToken)
                workingDirectory: $(workDir)
                environment: ${{ parameters.environment }}

                
            - template: pipeline-steps/terraform-prep.yaml
              parameters:
                terraformVersion: $(tfVersion)
                subscription: $(subscription)
                environment: ${{ parameters.environment }}
                resourceGroup: $(resourceGroup)
                location: $(location)
                storageAccount: $(storageAccount)
                containerName: $(containerName)
                stateKey: $(stateKey)-${{ parameters.environment }}.tfstate
                workingDirectory: $(workDir)

            - template: pipeline-steps/terraform-plan.yaml
              parameters:
                subscription: $(subscription)
                environment: ${{ parameters.environment }}
                tfVariables: $(System.DefaultWorkingDirectory)/$(tfDirectory)/$(tfVariables)
                workingDirectory: $(workDir)

            - template: pipeline-steps/terraform-apply.yaml
              parameters:
                subscription: $(subscription)
                environment: ${{ parameters.environment }}
                planLocation: $(System.DefaultWorkingDirectory)/$(tfDirectory)/${{ parameters.environment }}.tfplan
                workingDirectory: $(workDir)

# If you need to destroy this infra, delete and purge the secret from the keyvault before you run the destroy stage
  - ${{ if eq('${{ parameters.Run_Stage }}', 'DestroyAzureAgent') }}:
    - stage: DestroyAzureAgent
      displayName: Destroy Azure Devops Agent for ${{ parameters.environment }}

      jobs:
      - job: Destroy_Terraform
        displayName: Destroy Azure DevOps Agent in ${{ parameters.environment }}
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          
          - template: pipeline-steps/terraform-prep.yaml
            parameters:
              terraformVersion: $(tfVersion)
              subscription: $(subscription)
              environment: ${{ parameters.environment }}
              resourceGroup: $(resourceGroup)
              location: $(location)
              storageAccount: $(storageAccount)
              containerName: $(containerName)
              stateKey: $(stateKey)-${{ parameters.environment }}.tfstate
              workingDirectory: $(workDir)

          - task: TerraformCLI@0
            displayName: Terraform plan destroy
            inputs:
              command: plan
              workingDirectory: $(System.DefaultWorkingDirectory)/$(tfDirectory)
              environmentServiceName: $(subscription)
              commandOptions: '-destroy -var-file=$(tfVariables) -out=$(System.DefaultWorkingDirectory)/$(tfDirectory)/${{ parameters.environment }}-destroy.tfplan'

          - template: pipeline-steps/terraform-apply.yaml
            parameters:
              subscription: $(subscription)
              environment: ${{ parameters.environment }}
              planLocation: $(System.DefaultWorkingDirectory)/$(tfDirectory)/${{ parameters.environment }}-destroy.tfplan
              workingDirectory: $(workDir) 
