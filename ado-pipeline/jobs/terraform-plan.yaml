parameters:
  - name: subscription
    type: string
  - name: workingDirectory
    type: string
  - name: tfVariables
    type: string
  - name: environment
    type: string

steps:

  - bash: |
      mkdir '$(System.DefaultWorkingDirectory)/plans'
      dir_conts=$(ls -ltr $(System.DefaultWorkingDirectory)/plans)
      echo $dir_conts
      targetPath=$(pwd '$(System.DefaultWorkingDirectory)/plans')
      echo $targetPath
    displayName: Create plan directory

  - task: TerraformCLI@0
    displayName: Terraform plan
    inputs:
      command: plan
      workingDirectory: ${{ parameters.workingDirectory }}
      environmentServiceName: ${{ parameters.subscription }}
      commandOptions: '-var-file=${{ parameters.tfVariables }} -out=${{ parameters.workingDirectory }}/${{ parameters.environment }}-agent.tfplan'


  - task: PublishPipelineArtifact@1
    displayName: 'Publish Terraform Plan'
    inputs:
      targetPath: '${{ parameters.workingDirectory }}/plans/'
      artifact: '${{ parameters.environment }}-agent.tfplan'
      FileCopyOptions: '/xo'